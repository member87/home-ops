apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: pihole
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  sources:
    - repoURL: https://mojo2600.github.io/pihole-kubernetes/
      chart: pihole
      targetRevision: 2.35.0
      helm:
        valuesObject:
          # Admin password disabled - protected by Authelia
          # Note: Some PiHole Helm charts require setting webPassword instead
          webPassword: ""
          
          # Persistent storage using local-path provisioner
          persistentVolumeClaim:
            enabled: true
            size: "2Gi"
            storageClass: "local-path"
            accessModes:
              - ReadWriteOnce
          
          # DNS Service Configuration - using LoadBalancer with MetalLB
          serviceDns:
            mixedService: true
            type: LoadBalancer
            loadBalancerIP: "10.0.0.201"
            port: 53
            annotations:
              metallb.universe.tf/allow-shared-ip: pihole-svc
          
          # Web Interface Service Configuration
          serviceWeb:
            http:
              enabled: true
              port: 80
            https:
              enabled: true
              port: 443
            type: LoadBalancer
            loadBalancerIP: "10.0.0.201"
            annotations:
              metallb.universe.tf/allow-shared-ip: pihole-svc
          
          # DHCP Service - disable if not needed
          serviceDhcp:
            enabled: false
          
          # DNS Configuration
          DNS1: "1.1.1.1"
          DNS2: "1.0.0.1"
          
          # DNSMasq custom configuration
          dnsmasq:
            enableCustomDnsMasq: true
            customDnsEntries:
              # Wildcard DNS for lab domain - routes all *.lab.jackhumes.com to Traefik
              - address=/.lab.jackhumes.com/10.0.0.200
            customCnameEntries: []
            upstreamServers: []
          
          # Environment variables
          extraEnvVars:
            TZ: "UTC"
            FTLCONF_dns_listeningMode: "all"
            FTLCONF_misc_dnsmasq_lines: "address=/.lab.jackhumes.com/10.0.0.200"
          
          # Pod DNS Configuration
          # Use external DNS during startup to avoid chicken-and-egg problem
          podDnsConfig:
            enabled: true
            policy: "None"
            nameservers:
              - 1.1.1.1
              - 1.0.0.1
          
          # Resources
          resources:
            limits:
              cpu: 500m
              memory: 512Mi
            requests:
              cpu: 100m
              memory: 128Mi
          
          # Additional blocklists
          adlists:
            - https://raw.githubusercontent.com/StevenBlack/hosts/master/hosts
            - https://dbl.oisd.nl/
          
          # Monitoring
          monitoring:
            podMonitor:
              enabled: false
            sidecar:
              enabled: false
    - repoURL: https://github.com/member87/home-ops.git
      targetRevision: HEAD
      path: apps/pihole
  destination:
    server: https://kubernetes.default.svc
    namespace: pihole
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
      allowEmpty: false
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m
