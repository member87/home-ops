---
apiVersion: v1
kind: ConfigMap
metadata:
  name: clickhouse-init-schema
  namespace: clickhouse
data:
  01-create-database.sql: |
    CREATE DATABASE IF NOT EXISTS netflow;

  02-create-flows-table.sql: |
    CREATE TABLE IF NOT EXISTS netflow.flows
    (
        time_received DateTime,
        time_flow_start DateTime64(9),
        time_flow_end DateTime64(9),
        sampler_address IPv4,
        src_addr IPv4,
        dst_addr IPv4,
        src_port UInt16,
        dst_port UInt16,
        proto UInt8,
        bytes UInt64,
        packets UInt64,
        tcp_flags UInt8,
        ip_tos UInt8,
        in_if UInt16,
        out_if UInt16,
        src_mac String,
        dst_mac String,
        vlan_id UInt16,
        etype String,
        next_hop IPv4,
        src_as UInt32,
        dst_as UInt32,
        forwarding_status UInt8
    )
    ENGINE = MergeTree()
    PARTITION BY toYYYYMMDD(time_received)
    ORDER BY (time_received, sampler_address, src_addr, dst_addr)
    TTL time_received + INTERVAL 30 DAY
    SETTINGS index_granularity = 8192;

  03-create-materialized-views.sql: |
    -- Top talkers by source IP
    CREATE MATERIALIZED VIEW IF NOT EXISTS netflow.top_sources_mv
    ENGINE = SummingMergeTree()
    PARTITION BY toYYYYMMDD(time_received)
    ORDER BY (time_received, src_addr)
    TTL time_received + INTERVAL 30 DAY
    AS SELECT
        toStartOfFiveMinute(time_received) as time_received,
        src_addr,
        sum(bytes) as total_bytes,
        sum(packets) as total_packets,
        count() as flow_count
    FROM netflow.flows
    GROUP BY time_received, src_addr;

    -- Top destinations
    CREATE MATERIALIZED VIEW IF NOT EXISTS netflow.top_destinations_mv
    ENGINE = SummingMergeTree()
    PARTITION BY toYYYYMMDD(time_received)
    ORDER BY (time_received, dst_addr)
    TTL time_received + INTERVAL 30 DAY
    AS SELECT
        toStartOfFiveMinute(time_received) as time_received,
        dst_addr,
        sum(bytes) as total_bytes,
        sum(packets) as total_packets,
        count() as flow_count
    FROM netflow.flows
    GROUP BY time_received, dst_addr;

    -- Protocol statistics
    CREATE MATERIALIZED VIEW IF NOT EXISTS netflow.protocol_stats_mv
    ENGINE = SummingMergeTree()
    PARTITION BY toYYYYMMDD(time_received)
    ORDER BY (time_received, proto)
    TTL time_received + INTERVAL 30 DAY
    AS SELECT
        toStartOfFiveMinute(time_received) as time_received,
        proto,
        sum(bytes) as total_bytes,
        sum(packets) as total_packets,
        count() as flow_count
    FROM netflow.flows
    GROUP BY time_received, proto;
