---
# CrowdSec LAPI + Agent - decision engine with log parsing
# Reads Authelia logs from Loki for brute-force detection
apiVersion: apps/v1
kind: Deployment
metadata:
  name: crowdsec
  namespace: crowdsec
  labels:
    app: crowdsec
spec:
  replicas: 1
  selector:
    matchLabels:
      app: crowdsec
  template:
    metadata:
      labels:
        app: crowdsec
    spec:
      serviceAccountName: crowdsec
      containers:
        - name: crowdsec
          image: crowdsecurity/crowdsec:v1.6.8
          env:
            # Register the Traefik bouncer with this API key
            - name: BOUNCER_KEY_traefik
              valueFrom:
                secretKeyRef:
                  name: crowdsec-secrets
                  key: BOUNCER_KEY
            # Install collections - Authelia for brute-force detection
            - name: COLLECTIONS
              value: "crowdsecurity/traefik crowdsecurity/base-http-scenarios LePresidente/authelia"
          ports:
            - name: lapi
              containerPort: 8080
              protocol: TCP
          resources:
            requests:
              memory: 128Mi
              cpu: 100m
            limits:
              memory: 512Mi
              cpu: 500m
          volumeMounts:
            - name: crowdsec-data
              mountPath: /var/lib/crowdsec/data
            - name: acquis-config
              mountPath: /etc/crowdsec/acquis-loki/
              readOnly: true
            - name: acquis-config
              mountPath: /etc/crowdsec/config.yaml.local
              subPath: config.yaml.local
              readOnly: true
          livenessProbe:
            httpGet:
              path: /health
              port: lapi
            initialDelaySeconds: 90
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /health
              port: lapi
            initialDelaySeconds: 45
            periodSeconds: 5
      volumes:
        - name: crowdsec-data
          persistentVolumeClaim:
            claimName: crowdsec-data
        - name: acquis-config
          configMap:
            name: crowdsec-acquis
