---
# CrowdSec - combines LAPI (decision engine) and Agent (log parser)
# Single deployment for simplicity in Kubernetes
apiVersion: apps/v1
kind: Deployment
metadata:
  name: crowdsec
  namespace: crowdsec
  labels:
    app: crowdsec
spec:
  replicas: 1
  selector:
    matchLabels:
      app: crowdsec
  template:
    metadata:
      labels:
        app: crowdsec
    spec:
      serviceAccountName: crowdsec
      containers:
        - name: crowdsec
          image: crowdsecurity/crowdsec:v1.6.8
          env:
            # Register the Traefik bouncer with this API key
            - name: BOUNCER_KEY_traefik
              valueFrom:
                secretKeyRef:
                  name: crowdsec-secrets
                  key: BOUNCER_KEY
            # Install required parsers and scenarios for HTTP/auth detection
            - name: COLLECTIONS
              value: "crowdsecurity/traefik crowdsecurity/base-http-scenarios crowdsecurity/http-cve"
          ports:
            - name: lapi
              containerPort: 8080
              protocol: TCP
          resources:
            requests:
              memory: 256Mi
              cpu: 100m
            limits:
              memory: 512Mi
              cpu: 500m
          volumeMounts:
            - name: crowdsec-data
              mountPath: /var/lib/crowdsec/data
            - name: acquis-config
              mountPath: /etc/crowdsec/acquis.d
            - name: varlog
              mountPath: /var/log
              readOnly: true
          livenessProbe:
            httpGet:
              path: /health
              port: lapi
            initialDelaySeconds: 60
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /health
              port: lapi
            initialDelaySeconds: 30
            periodSeconds: 5
      volumes:
        - name: crowdsec-data
          persistentVolumeClaim:
            claimName: crowdsec-data
        - name: acquis-config
          configMap:
            name: crowdsec-acquis
        - name: varlog
          hostPath:
            path: /var/log
            type: Directory
