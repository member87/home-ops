---
# CrowdSec LAPI - decision engine for the bouncer
# Runs without log parsing agent - uses community blocklist + manual bans
# Log parsing requires hostPath which violates PodSecurity policy
apiVersion: apps/v1
kind: Deployment
metadata:
  name: crowdsec
  namespace: crowdsec
  labels:
    app: crowdsec
spec:
  replicas: 1
  selector:
    matchLabels:
      app: crowdsec
  template:
    metadata:
      labels:
        app: crowdsec
    spec:
      serviceAccountName: crowdsec
      containers:
        - name: crowdsec
          image: crowdsecurity/crowdsec:v1.6.8
          env:
            # Disable the agent (no log parsing) - LAPI only mode
            - name: DISABLE_AGENT
              value: "true"
            # Register the Traefik bouncer with this API key
            - name: BOUNCER_KEY_traefik
              valueFrom:
                secretKeyRef:
                  name: crowdsec-secrets
                  key: BOUNCER_KEY
            # Install collections for decision types
            - name: COLLECTIONS
              value: "crowdsecurity/traefik crowdsecurity/base-http-scenarios"
          ports:
            - name: lapi
              containerPort: 8080
              protocol: TCP
          resources:
            requests:
              memory: 128Mi
              cpu: 100m
            limits:
              memory: 256Mi
              cpu: 300m
          volumeMounts:
            - name: crowdsec-data
              mountPath: /var/lib/crowdsec/data
          livenessProbe:
            httpGet:
              path: /health
              port: lapi
            initialDelaySeconds: 60
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /health
              port: lapi
            initialDelaySeconds: 30
            periodSeconds: 5
      volumes:
        - name: crowdsec-data
          persistentVolumeClaim:
            claimName: crowdsec-data
