---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-alerting
  namespace: grafana
data:
  contactpoints.yaml: |
    apiVersion: 1
    contactPoints:
      - orgId: 1
        name: discord
        receivers:
          - uid: discord-webhook
            type: discord
            settings:
              url: $DISCORD_WEBHOOK_URL
              title: "{{ .CommonLabels.alertname }}"
              message: |
                **Status:** {{ .Status }}
                **Summary:** {{ .CommonAnnotations.summary }}
                
                **Details:**
                {{ range .Alerts }}
                - **{{ .Labels.alertname }}**: {{ .Annotations.description }}
                  Severity: {{ .Labels.severity }}
                {{ end }}
              use_discord_username: true
            disableResolveMessage: false
  
  policies.yaml: |
    apiVersion: 1
    policies:
      - orgId: 1
        receiver: discord
        group_by: ['alertname', 'cluster', 'namespace']
        group_wait: 30s
        group_interval: 5m
        repeat_interval: 4h
        routes:
          - receiver: discord
            matchers:
              - severity =~ "critical|warning"
            continue: false
            group_wait: 10s
            group_interval: 5m
            repeat_interval: 12h
  
  rules.yaml: |
    apiVersion: 1
    groups:
      - orgId: 1
        name: kubernetes-alerts
        folder: Kubernetes
        interval: 1m
        rules: []
          # All alert rules have been disabled to suppress notifications
          # To re-enable alerts, uncomment the desired rules from git history
          # 
          # Available alerts (15 total):
          # 1. pod-not-ready - Pod not in Running/Succeeded state for >5min (warning)
          # 2. network-errors-high - Network interface errors >0.01/s for >5min (warning)
          # 3. network-packet-drop-high - Packet drops >0.1/s for >5min (warning)
          # 4. tcp-retransmit-high - TCP retransmit rate >5% for >5min (warning)
          # 5. pod-cpu-throttling - CPU throttling >0.1s for >10min (warning)
          # 6. pod-memory-near-limit - Memory usage >90% of limit for >5min (warning)
          # 7. pod-oom-killed - Pod killed due to OOM (critical)
          # 8. network-interface-down - Physical network interface down >2min (critical)
          # 9. persistent-volume-full - PV usage >85% for >5min (warning)
          # 10. node-memory-high - Node memory usage >85% for >5min (warning)
          # 11. node-cpu-high - Node CPU usage >80% for >5min (warning)
          # 12. node-disk-high - Node /var disk usage >80% for >5min (warning)
          # 13. pod-restart-high - Pod restarting >5 times/hour for >5min (critical)
          # 14. node-temp-high - Node temperature >75Â°C for >5min (warning)
