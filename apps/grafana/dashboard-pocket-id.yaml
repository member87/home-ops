---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-pocket-id
  namespace: grafana
  labels:
    grafana_dashboard: "1"
  annotations:
    grafana_folder: "Security"
data:
  pocket-id.json: |
    {
      "title": "Pocket ID",
      "uid": "pocket-id-dashboard",
      "timezone": "browser",
      "schemaVersion": 40,
      "version": 1,
      "refresh": "30s",
      "templating": {
        "list": [
          {
            "name": "promDatasource",
            "label": "Prometheus",
            "type": "datasource",
            "query": "prometheus",
            "multi": false,
            "current": {
              "text": "Prometheus",
              "value": "prometheus"
            }
          },
          {
            "name": "lokiDatasource",
            "label": "Loki",
            "type": "datasource",
            "query": "loki",
            "multi": false,
            "current": {
              "text": "Loki",
              "value": "loki"
            }
          }
        ]
      },
      "annotations": {
        "list": [
          {
            "builtIn": 1,
            "datasource": {
              "type": "grafana",
              "uid": "-- Grafana --"
            },
            "enable": true,
            "hide": true,
            "iconColor": "rgba(0, 211, 255, 1)",
            "name": "Annotations & Alerts",
            "type": "dashboard"
          }
        ]
      },
      "panels": [
        {
          "type": "row",
          "title": "Service Status",
          "gridPos": {"h": 1, "w": 24, "x": 0, "y": 0},
          "collapsed": false
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "${promDatasource}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "mappings": [
                {"options": {"0": {"color": "red", "index": 0, "text": "DOWN"}}, "type": "value"},
                {"options": {"1": {"color": "green", "index": 1, "text": "UP"}}, "type": "value"}
              ],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "red", "value": null},
                  {"color": "green", "value": 1}
                ]
              },
              "unit": "none"
            }
          },
          "gridPos": {"h": 4, "w": 4, "x": 0, "y": 1},
          "id": 1,
          "options": {
            "colorMode": "background",
            "graphMode": "none",
            "justifyMode": "center",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "",
              "values": false
            },
            "textMode": "value"
          },
          "pluginVersion": "11.3.0",
          "targets": [
            {
              "datasource": {"type": "prometheus", "uid": "${promDatasource}"},
              "editorMode": "code",
              "expr": "up{job=\"pocket-id\"}",
              "legendFormat": "__auto",
              "range": true,
              "refId": "A"
            }
          ],
          "title": "Service Status",
          "type": "stat"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "${promDatasource}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "blue", "value": null}
                ]
              },
              "unit": "none"
            }
          },
          "gridPos": {"h": 4, "w": 4, "x": 4, "y": 1},
          "id": 2,
          "options": {
            "colorMode": "value",
            "graphMode": "none",
            "justifyMode": "center",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "/.*service_version.*/",
              "values": false
            },
            "textMode": "name"
          },
          "pluginVersion": "11.3.0",
          "targets": [
            {
              "datasource": {"type": "prometheus", "uid": "${promDatasource}"},
              "editorMode": "code",
              "expr": "target_info{job=\"pocket-id\"}",
              "format": "table",
              "legendFormat": "{{service_version}}",
              "range": true,
              "refId": "A"
            }
          ],
          "title": "Version",
          "transformations": [
            {
              "id": "reduce",
              "options": {
                "reducers": ["lastNotNull"]
              }
            }
          ],
          "type": "stat"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "${promDatasource}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "green", "value": null},
                  {"color": "yellow", "value": 0.5},
                  {"color": "red", "value": 1}
                ]
              },
              "unit": "s"
            }
          },
          "gridPos": {"h": 4, "w": 4, "x": 8, "y": 1},
          "id": 3,
          "options": {
            "colorMode": "value",
            "graphMode": "area",
            "justifyMode": "center",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": ["mean"],
              "fields": "",
              "values": false
            },
            "textMode": "auto"
          },
          "pluginVersion": "11.3.0",
          "targets": [
            {
              "datasource": {"type": "prometheus", "uid": "${promDatasource}"},
              "editorMode": "code",
              "expr": "scrape_duration_seconds{job=\"pocket-id\"}",
              "legendFormat": "__auto",
              "range": true,
              "refId": "A"
            }
          ],
          "title": "Scrape Duration",
          "type": "stat"
        },
        {
          "datasource": {
            "type": "loki",
            "uid": "${lokiDatasource}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "green", "value": null},
                  {"color": "yellow", "value": 10},
                  {"color": "red", "value": 50}
                ]
              },
              "unit": "none"
            }
          },
          "gridPos": {"h": 4, "w": 4, "x": 12, "y": 1},
          "id": 4,
          "options": {
            "colorMode": "value",
            "graphMode": "area",
            "justifyMode": "center",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "",
              "values": false
            },
            "textMode": "auto"
          },
          "pluginVersion": "11.3.0",
          "targets": [
            {
              "datasource": {"type": "loki", "uid": "${lokiDatasource}"},
              "editorMode": "code",
              "expr": "sum(count_over_time({namespace=\"pocket-id\"} |~ \"level.*(error|ERROR)\" [$__range]))",
              "queryType": "instant",
              "refId": "A"
            }
          ],
          "title": "Errors (Period)",
          "type": "stat"
        },
        {
          "datasource": {
            "type": "loki",
            "uid": "${lokiDatasource}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "blue", "value": null}
                ]
              },
              "unit": "none"
            }
          },
          "gridPos": {"h": 4, "w": 4, "x": 16, "y": 1},
          "id": 5,
          "options": {
            "colorMode": "value",
            "graphMode": "area",
            "justifyMode": "center",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "",
              "values": false
            },
            "textMode": "auto"
          },
          "pluginVersion": "11.3.0",
          "targets": [
            {
              "datasource": {"type": "loki", "uid": "${lokiDatasource}"},
              "editorMode": "code",
              "expr": "sum(count_over_time({namespace=\"pocket-id\"} |~ \"(login|signin|authenticated)\" [$__range]))",
              "queryType": "instant",
              "refId": "A"
            }
          ],
          "title": "Auth Events (Period)",
          "type": "stat"
        },
        {
          "datasource": {
            "type": "loki",
            "uid": "${lokiDatasource}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "orange", "value": null}
                ]
              },
              "unit": "none"
            }
          },
          "gridPos": {"h": 4, "w": 4, "x": 20, "y": 1},
          "id": 6,
          "options": {
            "colorMode": "value",
            "graphMode": "area",
            "justifyMode": "center",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "",
              "values": false
            },
            "textMode": "auto"
          },
          "pluginVersion": "11.3.0",
          "targets": [
            {
              "datasource": {"type": "loki", "uid": "${lokiDatasource}"},
              "editorMode": "code",
              "expr": "sum(count_over_time({namespace=\"pocket-id\"} |~ \"(failed|denied|unauthorized|invalid)\" [$__range]))",
              "queryType": "instant",
              "refId": "A"
            }
          ],
          "title": "Failed Auth (Period)",
          "type": "stat"
        },
        {
          "type": "row",
          "title": "Resource Usage",
          "gridPos": {"h": 1, "w": 24, "x": 0, "y": 5},
          "collapsed": false
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "${promDatasource}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "palette-classic"},
              "custom": {
                "axisBorderShow": false,
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "CPU Cores",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 20,
                "gradientMode": "none",
                "hideFrom": {"tooltip": false, "viz": false, "legend": false},
                "insertNulls": false,
                "lineInterpolation": "smooth",
                "lineWidth": 2,
                "pointSize": 5,
                "scaleDistribution": {"type": "linear"},
                "showPoints": "never",
                "spanNulls": false,
                "stacking": {"group": "A", "mode": "none"},
                "thresholdsStyle": {"mode": "off"}
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [{"color": "green", "value": null}]
              },
              "unit": "short"
            }
          },
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 6},
          "id": 7,
          "options": {
            "legend": {"calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true},
            "tooltip": {"mode": "multi", "sort": "desc"}
          },
          "pluginVersion": "11.3.0",
          "targets": [
            {
              "datasource": {"type": "prometheus", "uid": "${promDatasource}"},
              "editorMode": "code",
              "expr": "sum(rate(container_cpu_usage_seconds_total{namespace=\"pocket-id\", container!=\"\", container!=\"POD\"}[5m])) by (container)",
              "legendFormat": "{{container}}",
              "range": true,
              "refId": "A"
            }
          ],
          "title": "CPU Usage",
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "${promDatasource}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "palette-classic"},
              "custom": {
                "axisBorderShow": false,
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "Memory",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 20,
                "gradientMode": "none",
                "hideFrom": {"tooltip": false, "viz": false, "legend": false},
                "insertNulls": false,
                "lineInterpolation": "smooth",
                "lineWidth": 2,
                "pointSize": 5,
                "scaleDistribution": {"type": "linear"},
                "showPoints": "never",
                "spanNulls": false,
                "stacking": {"group": "A", "mode": "none"},
                "thresholdsStyle": {"mode": "off"}
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [{"color": "green", "value": null}]
              },
              "unit": "bytes"
            }
          },
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 6},
          "id": 8,
          "options": {
            "legend": {"calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true},
            "tooltip": {"mode": "multi", "sort": "desc"}
          },
          "pluginVersion": "11.3.0",
          "targets": [
            {
              "datasource": {"type": "prometheus", "uid": "${promDatasource}"},
              "editorMode": "code",
              "expr": "sum(container_memory_working_set_bytes{namespace=\"pocket-id\", container!=\"\", container!=\"POD\"}) by (container)",
              "legendFormat": "{{container}}",
              "range": true,
              "refId": "A"
            }
          ],
          "title": "Memory Usage",
          "type": "timeseries"
        },
        {
          "type": "row",
          "title": "Network Traffic",
          "gridPos": {"h": 1, "w": 24, "x": 0, "y": 14},
          "collapsed": false
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "${promDatasource}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "palette-classic"},
              "custom": {
                "axisBorderShow": false,
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "Bytes/sec",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 20,
                "gradientMode": "none",
                "hideFrom": {"tooltip": false, "viz": false, "legend": false},
                "insertNulls": false,
                "lineInterpolation": "smooth",
                "lineWidth": 2,
                "pointSize": 5,
                "scaleDistribution": {"type": "linear"},
                "showPoints": "never",
                "spanNulls": false,
                "stacking": {"group": "A", "mode": "none"},
                "thresholdsStyle": {"mode": "off"}
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [{"color": "green", "value": null}]
              },
              "unit": "Bps"
            },
            "overrides": [
              {
                "matcher": {"id": "byRegexp", "options": ".*transmit.*"},
                "properties": [{"id": "custom.transform", "value": "negative-Y"}]
              }
            ]
          },
          "gridPos": {"h": 8, "w": 24, "x": 0, "y": 15},
          "id": 9,
          "options": {
            "legend": {"calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true},
            "tooltip": {"mode": "multi", "sort": "desc"}
          },
          "pluginVersion": "11.3.0",
          "targets": [
            {
              "datasource": {"type": "prometheus", "uid": "${promDatasource}"},
              "editorMode": "code",
              "expr": "sum(rate(container_network_receive_bytes_total{namespace=\"pocket-id\"}[5m]))",
              "legendFormat": "receive",
              "range": true,
              "refId": "A"
            },
            {
              "datasource": {"type": "prometheus", "uid": "${promDatasource}"},
              "editorMode": "code",
              "expr": "sum(rate(container_network_transmit_bytes_total{namespace=\"pocket-id\"}[5m]))",
              "legendFormat": "transmit",
              "range": true,
              "refId": "B"
            }
          ],
          "title": "Network I/O",
          "type": "timeseries"
        },
        {
          "type": "row",
          "title": "Authentication Activity",
          "gridPos": {"h": 1, "w": 24, "x": 0, "y": 23},
          "collapsed": false
        },
        {
          "datasource": {
            "type": "loki",
            "uid": "${lokiDatasource}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "palette-classic"},
              "custom": {
                "axisBorderShow": false,
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "Events",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "bars",
                "fillOpacity": 80,
                "gradientMode": "none",
                "hideFrom": {"tooltip": false, "viz": false, "legend": false},
                "insertNulls": false,
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {"type": "linear"},
                "showPoints": "never",
                "spanNulls": false,
                "stacking": {"group": "A", "mode": "normal"},
                "thresholdsStyle": {"mode": "off"}
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [{"color": "green", "value": null}]
              }
            },
            "overrides": [
              {
                "matcher": {"id": "byName", "options": "Errors"},
                "properties": [{"id": "color", "value": {"fixedColor": "red", "mode": "fixed"}}]
              },
              {
                "matcher": {"id": "byName", "options": "Auth Success"},
                "properties": [{"id": "color", "value": {"fixedColor": "green", "mode": "fixed"}}]
              },
              {
                "matcher": {"id": "byName", "options": "Auth Failed"},
                "properties": [{"id": "color", "value": {"fixedColor": "orange", "mode": "fixed"}}]
              }
            ]
          },
          "gridPos": {"h": 8, "w": 24, "x": 0, "y": 24},
          "id": 10,
          "options": {
            "legend": {"calcs": ["sum"], "displayMode": "table", "placement": "right", "showLegend": true},
            "tooltip": {"mode": "multi", "sort": "desc"}
          },
          "pluginVersion": "11.3.0",
          "targets": [
            {
              "datasource": {"type": "loki", "uid": "${lokiDatasource}"},
              "editorMode": "code",
              "expr": "sum(count_over_time({namespace=\"pocket-id\"} |~ \"(login|signin|authenticated|authorized)\" [$__auto]))",
              "legendFormat": "Auth Success",
              "queryType": "range",
              "refId": "A"
            },
            {
              "datasource": {"type": "loki", "uid": "${lokiDatasource}"},
              "editorMode": "code",
              "expr": "sum(count_over_time({namespace=\"pocket-id\"} |~ \"(failed|denied|unauthorized|invalid)\" [$__auto]))",
              "legendFormat": "Auth Failed",
              "queryType": "range",
              "refId": "B"
            },
            {
              "datasource": {"type": "loki", "uid": "${lokiDatasource}"},
              "editorMode": "code",
              "expr": "sum(count_over_time({namespace=\"pocket-id\"} |~ \"level.*(error|ERROR)\" [$__auto]))",
              "legendFormat": "Errors",
              "queryType": "range",
              "refId": "C"
            }
          ],
          "interval": "1m",
          "title": "Authentication Events Over Time",
          "type": "timeseries"
        },
        {
          "type": "row",
          "title": "OIDC Activity",
          "gridPos": {"h": 1, "w": 24, "x": 0, "y": 32},
          "collapsed": false
        },
        {
          "datasource": {
            "type": "loki",
            "uid": "${lokiDatasource}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "palette-classic"},
              "custom": {
                "axisBorderShow": false,
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "Requests",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "bars",
                "fillOpacity": 80,
                "gradientMode": "none",
                "hideFrom": {"tooltip": false, "viz": false, "legend": false},
                "insertNulls": false,
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {"type": "linear"},
                "showPoints": "never",
                "spanNulls": false,
                "stacking": {"group": "A", "mode": "normal"},
                "thresholdsStyle": {"mode": "off"}
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [{"color": "green", "value": null}]
              }
            },
            "overrides": [
              {
                "matcher": {"id": "byName", "options": "Token Requests"},
                "properties": [{"id": "color", "value": {"fixedColor": "blue", "mode": "fixed"}}]
              },
              {
                "matcher": {"id": "byName", "options": "Authorize Requests"},
                "properties": [{"id": "color", "value": {"fixedColor": "purple", "mode": "fixed"}}]
              },
              {
                "matcher": {"id": "byName", "options": "Userinfo Requests"},
                "properties": [{"id": "color", "value": {"fixedColor": "cyan", "mode": "fixed"}}]
              }
            ]
          },
          "gridPos": {"h": 8, "w": 24, "x": 0, "y": 33},
          "id": 11,
          "options": {
            "legend": {"calcs": ["sum"], "displayMode": "table", "placement": "right", "showLegend": true},
            "tooltip": {"mode": "multi", "sort": "desc"}
          },
          "pluginVersion": "11.3.0",
          "targets": [
            {
              "datasource": {"type": "loki", "uid": "${lokiDatasource}"},
              "editorMode": "code",
              "expr": "sum(count_over_time({namespace=\"pocket-id\"} |~ \"/api/oidc/token\" [$__auto]))",
              "legendFormat": "Token Requests",
              "queryType": "range",
              "refId": "A"
            },
            {
              "datasource": {"type": "loki", "uid": "${lokiDatasource}"},
              "editorMode": "code",
              "expr": "sum(count_over_time({namespace=\"pocket-id\"} |~ \"/authorize\" [$__auto]))",
              "legendFormat": "Authorize Requests",
              "queryType": "range",
              "refId": "B"
            },
            {
              "datasource": {"type": "loki", "uid": "${lokiDatasource}"},
              "editorMode": "code",
              "expr": "sum(count_over_time({namespace=\"pocket-id\"} |~ \"/api/oidc/userinfo\" [$__auto]))",
              "legendFormat": "Userinfo Requests",
              "queryType": "range",
              "refId": "C"
            }
          ],
          "interval": "1m",
          "title": "OIDC Endpoint Activity",
          "type": "timeseries"
        },
        {
          "type": "row",
          "title": "Recent Logs",
          "gridPos": {"h": 1, "w": 24, "x": 0, "y": 41},
          "collapsed": false
        },
        {
          "datasource": {
            "type": "loki",
            "uid": "${lokiDatasource}"
          },
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 42},
          "id": 12,
          "options": {
            "dedupStrategy": "exact",
            "enableLogDetails": true,
            "prettifyLogMessage": false,
            "showCommonLabels": false,
            "showLabels": false,
            "showTime": true,
            "sortOrder": "Descending",
            "wrapLogMessage": true
          },
          "pluginVersion": "11.3.0",
          "targets": [
            {
              "datasource": {"type": "loki", "uid": "${lokiDatasource}"},
              "editorMode": "code",
              "expr": "{namespace=\"pocket-id\"} |~ \"level.*(error|ERROR|warn|WARN)\"",
              "queryType": "range",
              "refId": "A"
            }
          ],
          "title": "Errors & Warnings",
          "type": "logs"
        },
        {
          "datasource": {
            "type": "loki",
            "uid": "${lokiDatasource}"
          },
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 42},
          "id": 13,
          "options": {
            "dedupStrategy": "exact",
            "enableLogDetails": true,
            "prettifyLogMessage": false,
            "showCommonLabels": false,
            "showLabels": false,
            "showTime": true,
            "sortOrder": "Descending",
            "wrapLogMessage": true
          },
          "pluginVersion": "11.3.0",
          "targets": [
            {
              "datasource": {"type": "loki", "uid": "${lokiDatasource}"},
              "editorMode": "code",
              "expr": "{namespace=\"pocket-id\"} |~ \"(login|signin|authenticated|passkey|webauthn)\"",
              "queryType": "range",
              "refId": "A"
            }
          ],
          "title": "Authentication Logs",
          "type": "logs"
        },
        {
          "datasource": {
            "type": "loki",
            "uid": "${lokiDatasource}"
          },
          "gridPos": {"h": 10, "w": 24, "x": 0, "y": 50},
          "id": 14,
          "options": {
            "dedupStrategy": "exact",
            "enableLogDetails": true,
            "prettifyLogMessage": false,
            "showCommonLabels": false,
            "showLabels": false,
            "showTime": true,
            "sortOrder": "Descending",
            "wrapLogMessage": true
          },
          "pluginVersion": "11.3.0",
          "targets": [
            {
              "datasource": {"type": "loki", "uid": "${lokiDatasource}"},
              "editorMode": "code",
              "expr": "{namespace=\"pocket-id\"}",
              "queryType": "range",
              "refId": "A"
            }
          ],
          "title": "All Pocket ID Logs",
          "type": "logs"
        }
      ],
      "time": {"from": "now-6h", "to": "now"},
      "timepicker": {},
      "tags": ["security", "pocket-id", "oidc", "authentication"],
      "description": "Dashboard for monitoring Pocket ID OIDC provider - service status, resource usage, authentication events, and logs"
    }
