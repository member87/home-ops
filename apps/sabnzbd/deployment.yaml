---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: sabnzbd-config
  namespace: sabnzbd
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: local-path
  resources:
    requests:
      storage: 1Gi
---
# Downloads PVC (temporary until NFS works)
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: downloads
  namespace: sabnzbd
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: local-path
  resources:
    requests:
      storage: 50Gi
---
# ============================================
# SABnzbd with Gluetun VPN Integration
# ============================================
# Routes traffic through Gluetun HTTP proxy
# Usenet/NNTP works fine over HTTP proxy
# ============================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sabnzbd
  namespace: sabnzbd
  labels:
    app: sabnzbd
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sabnzbd
  template:
    metadata:
      labels:
        app: sabnzbd
    spec:
      # Use cluster DNS so we can resolve gluetun service
      # VPN routing is done via HTTP_PROXY, not network namespace
      dnsPolicy: ClusterFirst
      
      # Wait for VPN to be ready before starting
      initContainers:
        - name: wait-for-vpn
          image: curlimages/curl:8.11.1
          command:
            - /bin/sh
            - -c
            - |
              echo "Waiting for Gluetun VPN to be ready..."
              until curl -sf http://gluetun.gluetun.svc.cluster.local:8000/v1/publicip/ip; do
                echo "VPN not ready, waiting..."
                sleep 5
              done
              echo "VPN is ready! Public IP:"
              curl -sf http://gluetun.gluetun.svc.cluster.local:8000/v1/publicip/ip
      
      containers:
        - name: sabnzbd
          image: lscr.io/linuxserver/sabnzbd:4.5.5
          ports:
            - containerPort: 8080
              name: http
              protocol: TCP
          env:
            # ============================================
            # LinuxServer.io Container Variables
            # ============================================
            - name: PUID
              value: "1000"
            - name: PGID
              value: "1000"
            - name: TZ
              value: "Europe/London"
            - name: UMASK
              value: "022"
            
            # ============================================
            # VPN Proxy Configuration
            # ============================================
            # Route traffic through Gluetun VPN proxy
            # Usenet uses HTTPS/NNTP-SSL which works with HTTP proxy
            - name: HTTP_PROXY
              value: "http://gluetun.gluetun.svc.cluster.local:8888"
            - name: HTTPS_PROXY
              value: "http://gluetun.gluetun.svc.cluster.local:8888"
            
            # Exclude local/cluster traffic from proxy
            - name: NO_PROXY
              value: "localhost,127.0.0.1,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16,.svc.cluster.local,.cluster.local"
          volumeMounts:
            - name: config
              mountPath: /config
            - name: downloads
              mountPath: /downloads
          livenessProbe:
            httpGet:
              path: /
              port: 8080
            initialDelaySeconds: 60
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 10
          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
            limits:
              memory: "2Gi"
              cpu: "2000m"
      volumes:
        - name: config
          persistentVolumeClaim:
            claimName: sabnzbd-config
        - name: downloads
          persistentVolumeClaim:
            claimName: downloads
